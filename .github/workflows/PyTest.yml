name: Python & Frontend CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, Wanghaiyang ]

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}, Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']
        node-version: ['24.x']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip wheel
          pip install -e .
          pip install pytest pytest-cov flake8

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit hooks (format/lint)
        run: |
          # run all hooks against all files to ensure repo is clean in CI
          pre-commit run --all-files || true

      - name: Lint (flake8)
        run: |
          echo "Running flake8 lint..."
          # Install flake8-diff to check only changed files
          pip install flake8-diff
          # Run flake8 only on files changed in this PR compared to main branch
          flake8-diff origin/main || true

      - name: Run tests (pytest)
        env:
          CI: true
        run: |
          mkdir -p reports
          python -m pytest test/ -q --maxfail=1 --junitxml=reports/junit-${{ matrix.python-version }}.xml --cov=deeptracer --cov-report=xml:reports/coverage-${{ matrix.python-version }}.xml

      - name: Check for frontend files
        id: check-frontend-files
        run: |
          if git diff --name-only origin/main...HEAD | grep -E '\.(html|css|js|jsx|ts|tsx|vue)$' >/dev/null; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
          else
            echo "has_frontend=false" >> $GITHUB_OUTPUT
          fi

      - name: Install frontend dependencies
        if: steps.check-frontend-files.outputs.has_frontend == 'true'
        run: |
          npm install -g prettier eslint stylelint
          # Install ESLint plugins for React and Vue
          npm install -g eslint-plugin-react eslint-plugin-react-hooks eslint-plugin-vue
          # Install Stylelint plugins
          npm install -g stylelint-config-standard

      - name: Format check with Prettier
        if: steps.check-frontend-files.outputs.has_frontend == 'true'
        run: |
          echo "Running Prettier format check..."
          prettier --check "**/*.{html,css,js,jsx,ts,tsx,vue}" || echo "Prettier format check failed. Some files need formatting."

      - name: Lint JavaScript/TypeScript/React/Vue with ESLint
        if: steps.check-frontend-files.outputs.has_frontend == 'true'
        run: |
          echo "Running ESLint check..."
          # Create a basic ESLint config if it doesn't exist
          if [ ! -f .eslintrc.js ] && [ ! -f .eslintrc.json ]; then
            echo "module.exports = { env: { browser: true, es2021: true, node: true }, extends: ['eslint:recommended', 'plugin:react/recommended', 'plugin:vue/vue3-recommended'], parserOptions: { ecmaFeatures: { jsx: true }, ecmaVersion: 'latest', sourceType: 'module' }, plugins: ['react', 'react-hooks', 'vue'], rules: { 'react/react-in-jsx-scope': 'off' }, settings: { react: { version: 'detect' } } };" > .eslintrc.js
          fi
          eslint "**/*.{js,jsx,ts,tsx,vue}" --max-warnings 0 || echo "ESLint check failed. Please fix the issues."

      - name: Lint CSS with Stylelint
        if: steps.check-frontend-files.outputs.has_frontend == 'true'
        run: |
          echo "Running Stylelint check..."
          # Create a basic Stylelint config if it doesn't exist
          if [ ! -f stylelint.config.js ] && [ ! -f .stylelintrc.json ]; then
            echo "module.exports = { extends: 'stylelint-config-standard' };" > stylelint.config.js
          fi
          stylelint "**/*.css" --max-warnings 0 || echo "Stylelint check failed. Please fix the issues."

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: pytest-reports-${{ matrix.python-version }}
          path: reports/**