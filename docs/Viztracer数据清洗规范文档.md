# Viztracer 数据清洗规范文档

## 1. 概述

本文档定义了 Viztracer 原始性能分析数据的清洗规则和目标数据结构，旨在通过过滤、聚合、剪枝和简化等操作，在保留完整性能画像的前提下，减少数据体积并降低前端渲染复杂度。

## 2. 原始数据结构分析

### 2.1 核心字段

Viztracer 原始数据的核心是 `traceEvents` 数组，包含以下关键字段：

| 字段名 | 类型 | 描述 |
|-------|------|------|
| `name` | 字符串 | 函数名称或事件名称 |
| `ph` | 字符串 | 事件类型（'B' 开始, 'E' 结束） |
| `ts` | 数字 | 时间戳（微秒） |
| `pid` | 数字 | 进程ID |
| `tid` | 数字 | 线程ID |
| `cat` | 字符串 | 事件类别（可选） |
| `args` | 对象 | 附加参数（可选） |

### 2.2 冗余性分析

原始数据中可能包含以下非核心信息：
- 耗时极短（< 0.1 毫秒）的调用事件
- 同一函数在极短时间内的连续重复调用
- 过深或过于复杂的调用子树（尤其是系统库或框架内部）
- 对可视化分析非必需的元数据字段

## 3. 数据清洗规则

### 3.1 过滤

- **规则**：移除耗时低于可配置阈值的极短调用事件
- **默认阈值**：0.1 毫秒（100 微秒）
- **目的**：聚焦关键路径，减少数据量

### 3.2 聚合

- **规则**：对于同一函数在极短时间内连续多次被调用且无其他中断的情况，合并为一个带有总时长的调用事件
- **默认聚合阈值**：0.5 毫秒（500 微秒）
- **目的**：减少相似事件的重复展示

### 3.3 剪枝

- **规则**：识别并可能折叠过深或过于复杂的调用子树，特别是系统库或框架内部的细节
- **默认最大深度**：10 层
- **目的**：简化可视化，突出应用层逻辑

### 3.4 简化

- **规则**：去除对可视化分析非必需的元数据字段
- **保留字段**：函数名、开始时间、结束时间、持续时间、调用层级深度、所属线程/进程、父/子调用关系
- **移除字段**：特定内部标识符、调试元数据等

## 4. 目标数据结构

### 4.1 清洗后的函数调用数据

```typescript
interface FunctionCall {
  id: string;                // 唯一标识符
  name: string;              // 函数名称
  startTime: number;         // 开始时间（微秒）
  endTime: number;           // 结束时间（微秒）
  duration: number;          // 持续时间（微秒）
  depth: number;             // 调用层级深度
  threadId: number;          // 线程ID
  processId: number;         // 进程ID
  parentId?: string;         // 父调用ID（可选）
  childrenIds: string[];     // 子调用ID列表
  isActive: boolean;         // 是否当前正在执行
  lineNumber?: number;       // 代码行号（可选）
}
```

### 4.2 清洗后的性能数据

```typescript
interface CleanedViztracerData {
  functionCalls: FunctionCall[];  // 函数调用列表
  threads: number[];              // 线程ID列表
  startTime: number;              // 开始时间（微秒）
  endTime: number;                // 结束时间（微秒）
  totalDuration: number;          // 总持续时间（微秒）
}
```

## 5. 清洗效果目标

- **数据体积减少**：30%-50%
- **渲染复杂度降低**：减少前端需要处理的事件数量，提高渲染性能
- **性能画像完整性**：保留关键性能信息，确保分析结果准确

## 6. 实现细节

### 6.1 调用栈构建

通过匹配开始事件（'B'）和结束事件（'E'），构建完整的函数调用栈，计算每个调用的持续时间和深度。

### 6.2 父子关系处理

为每个函数调用记录父调用ID和子调用ID列表，便于构建调用关系图。

### 6.3 线程隔离

对每个线程单独构建调用栈，确保线程间的函数调用关系正确。

## 7. 配置参数

清洗过程支持以下可配置参数：

| 参数名 | 类型 | 默认值 | 描述 |
|-------|------|-------|------|
| `minDuration` | 数字 | 100 | 最小调用时长阈值（微秒） |
| `maxDepth` | 数字 | 10 | 最大调用深度 |
| `enableAggregation` | 布尔值 | true | 是否启用连续调用聚合 |
| `aggregationThreshold` | 数字 | 500 | 聚合阈值（微秒） |
