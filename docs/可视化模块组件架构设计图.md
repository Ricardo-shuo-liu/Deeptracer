# 可视化模块组件架构设计图

## 1. 架构概述

Viztracer 数据可视化模块采用基于 React 的组件化架构，结合 ECharts 进行图表渲染，使用 Context API 进行状态管理。整体架构遵循单向数据流原则，确保组件间通信清晰可控。

## 2. 组件层级结构

```
App
├── Header
├── MainContent
│   ├── LeftPanel (50%)
│   │   ├── ExecutionFlow
│   │   │   ├── CodeDisplay
│   │   │   ├── CallGraph
│   │   │   └── ControlPanel
│   │   └── DataPanel
│   └── RightPanel (50%)
│       ├── ChartsContainer
│       │   ├── BarChart
│       │   └── LineChart
│       └── DiffViewer
└── Footer
```

### 2.1 核心组件说明

| 组件名称 | 功能描述 |
|---------|---------|
| **App** | 应用根组件，负责整体布局和状态管理 |
| **Header** | 应用头部，显示标题和基本信息 |
| **MainContent** | 主要内容区域，分为左右两个面板 |
| **LeftPanel** | 左侧面板，包含执行流和数据面板 |
| **ExecutionFlow** | 执行流程可视化组件 |
| **CodeDisplay** | 代码展示组件，高亮当前执行行 |
| **CallGraph** | 函数调用关系图 |
| **ControlPanel** | 控制面板，提供播放/暂停、步进等功能 |
| **DataPanel** | 数据面板，显示清洗后的性能数据 |
| **RightPanel** | 右侧面板，包含图表和差异查看器 |
| **ChartsContainer** | 图表容器组件 |
| **BarChart** | 柱状图组件，展示函数耗时排行榜 |
| **LineChart** | 折线图组件，展示函数调用时间线 |
| **DiffViewer** | 代码差异对比组件 |
| **Footer** | 应用底部，显示版权信息等 |

## 3. 数据流设计

### 3.1 数据流向

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  原始 Viztracer │────►│   数据清洗模块   │────►│   状态管理层     │
│     数据文件     │     │   (DataProcessor)  │     │  (Context API)   │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                      ▲
                                      │
                                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  执行流组件      │◄────┤  柱状图组件      │◄────┤  折线图组件      │
│ (ExecutionFlow) │     │   (BarChart)     │     │   (LineChart)    │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 3.2 数据处理流程

1. **数据输入**: 从 Viztracer 生成的原始 JSON 数据文件获取数据
2. **数据清洗**: 通过 DataProcessor 模块对原始数据进行过滤、聚合、剪枝和简化
3. **状态管理**: 清洗后的数据存储在 Context API 中，供所有组件共享
4. **组件渲染**: 各可视化组件从 Context 中获取数据并渲染
5. **用户交互**: 用户操作触发状态更新，通过 Context 同步到所有相关组件

## 4. 状态管理设计

### 4.1 全局状态

| 状态 Key | 类型 | 描述 |
|---------|------|------|
| `rawData` | ViztracerRawData | 原始 Viztracer 数据 |
| `cleanedData` | CleanedViztracerData | 清洗后的性能数据 |
| `currentStep` | number | 当前执行步骤 |
| `isPlaying` | boolean | 动画播放状态 |
| `selectedFunction` | string | 当前选中的函数 |
| `activeView` | string | 活跃的可视化视图 |
| `filterOptions` | FilterOptions | 用户应用的筛选条件 |
| `diffData` | DiffData | 当前的代码差异数据 |

### 4.2 状态更新机制

1. **数据更新**: 当原始数据或清洗配置变化时，重新计算清洗后的数据
2. **执行步骤更新**: 用户操作或自动播放导致当前步骤变化
3. **视图切换**: 用户切换不同的可视化视图
4. **筛选条件更新**: 用户应用筛选条件，更新显示的数据范围

## 5. 组件间通信

### 5.1 事件驱动通信

| 事件名称 | 触发组件 | 接收组件 | 描述 |
|---------|---------|---------|------|
| `stepChange` | ControlPanel | ExecutionFlow | 执行步骤变化 |
| `playPause` | ControlPanel | ExecutionFlow | 播放/暂停状态变化 |
| `functionSelect` | BarChart | LineChart | 选中特定函数 |
| `viewChange` | ChartsContainer | AllComponents | 视图切换 |
| `filterApply` | DataPanel | AllComponents | 应用筛选条件 |

### 5.2 数据共享

通过 Context API 实现全局数据共享，避免 props 逐层传递：

```typescript
// PerformanceContext.tsx
import { createContext, useContext, useState } from 'react';
import { ViztracerRawData, CleanedViztracerData } from './types';

interface PerformanceContextType {
  rawData: ViztracerRawData | null;
  cleanedData: CleanedViztracerData | null;
  currentStep: number;
  isPlaying: boolean;
  // ... 其他状态和方法
}

const PerformanceContext = createContext<PerformanceContextType | undefined>(undefined);

export const PerformanceProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [rawData, setRawData] = useState<ViztracerRawData | null>(null);
  const [cleanedData, setCleanedData] = useState<CleanedViztracerData | null>(null);
  const [currentStep, setCurrentStep] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  // ... 其他状态和方法

  return (
    <PerformanceContext.Provider value={{ rawData, cleanedData, currentStep, isPlaying, /* ... */ }}>
      {children}
    </PerformanceContext.Provider>
  );
};

export const usePerformanceContext = () => {
  const context = useContext(PerformanceContext);
  if (context === undefined) {
    throw new Error('usePerformanceContext must be used within a PerformanceProvider');
  }
  return context;
};
```

## 6. 扩展性设计

### 6.1 插件系统

设计插件接口，支持动态扩展可视化组件：

```typescript
interface VisualizationPlugin {
  name: string;
  component: React.FC<any>;
  icon: string;
  description: string;
}
```

### 6.2 数据格式扩展

采用适配器模式，支持多种性能分析工具的数据格式：

```typescript
interface DataAdapter {
  name: string;
  parse(rawData: any): ViztracerRawData;
}
```

## 7. 性能优化策略

### 7.1 数据层面

- 数据懒加载和分页
- 虚拟滚动显示大量数据
- 数据缓存机制

### 7.2 渲染层面

- React.memo 优化组件渲染
- 使用 useCallback 和 useMemo 减少不必要的重新计算
- 图表组件按需渲染

## 8. 技术选型

| 技术/库 | 用途 | 版本 |
|--------|------|------|
| React | UI 框架 | 18.2.0 |
| TypeScript | 类型系统 | 5.0.2 |
| ECharts | 图表库 | 5.4.3 |
| React ECharts | ECharts 的 React 包装 | 3.0.2 |
| Tailwind CSS | CSS 框架 | 3.3.3 |
| react-diff-viewer | 代码差异对比 | 3.4.0 |
| Context API | 状态管理 | React 内置 |

## 9. 未来扩展方向

1. **支持更多性能分析工具**: 扩展数据适配器，支持 Chrome DevTools、Perfetto 等工具的数据格式
2. **增强可视化效果**: 添加火焰图、热力图等更丰富的可视化组件
3. **实时分析功能**: 支持实时性能数据的采集和分析
4. **协作功能**: 添加注释和分享功能，支持团队协作分析
5. **导出功能**: 支持将分析结果导出为 PDF、PNG 等格式
